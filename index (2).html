<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Qq Music - Pro Soloist v26 (English UI)</title>
  <style>
    /* --- Ê†∏ÂøÉËÆäÊï∏ (Core Variables) --- */
    :root {
      --bg: #000000;
      --panel: #000000;
      --accent: #a855f7;
      --accent-glow: 0 0 15px var(--accent);
      --text: #ffffff;
      --lcd-bg: #0a0015;
      --lcd-border: 2px solid var(--accent);
      --key-white-bg: linear-gradient(to bottom, #f0f0f0 0%, #ffffff 100%);
      --key-black-bg: linear-gradient(to bottom, #444 0%, #000 100%);
      --border-radius: 8px;
      --font-family: "Orbitron", "Segoe UI", sans-serif;
      --white-w: 52px; 
      --black-w: 34px; 
      --octave-active-bg: #2a0044;
      --guide-color: #d946ef;
    }

    /* --- ‰∏ªÈ°å (Themes) --- */
    body.theme-cartoon { --bg: #87CEEB; --panel: #FFD700; --accent: #FF4500; --accent-glow: 4px 4px 0px rgba(0,0,0,0.2); --text: #000000; --lcd-bg: #FFFFFF; --lcd-border: 4px solid #FF4500; --key-white-bg: linear-gradient(to bottom, #ffffff 0%, #f0f8ff 100%); --key-black-bg: linear-gradient(to bottom, #333 0%, #333 100%); --border-radius: 25px; --font-family: "Comic Sans MS", cursive; --octave-active-bg: #ffeb3b; }
    body.theme-pro { --bg: #1a1a1a; --panel: #2c2c2c; --accent: #d4d4d4; --accent-glow: none; --text: #f0f0f0; --lcd-bg: #111; --lcd-border: 1px solid #555; --key-white-bg: linear-gradient(to bottom, #fffff0 0%, #ffffff 100%); --key-black-bg: linear-gradient(to bottom, #1a1a1a 0%, #000 100%); --border-radius: 2px; --font-family: "Times New Roman", serif; --octave-active-bg: #222; }
    body.theme-nature { --bg: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); --panel: #e6cca0; --accent: #006994; --accent-glow: 0 0 5px rgba(255,255,255,0.5); --text: #00334e; --lcd-bg: rgba(255,255,255,0.6); --lcd-border: 2px solid #006994; --key-white-bg: linear-gradient(to bottom, #f0faff 0%, #ffffff 100%); --key-black-bg: linear-gradient(to bottom, #006994 0%, #00334e 100%); --border-radius: 12px; --font-family: "Georgia", serif; --octave-active-bg: #004d40; }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font-family); min-height: 100vh; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; transition: background 0.8s ease, color 0.3s ease; background-attachment: fixed; }

    #themeModal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; display: none; }
    .modal-title { font-size: 28px; color: white; margin-bottom: 30px; text-align: center; }
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; width: 100%; }
    
    .theme-card { background: #222; border: 3px solid #444; border-radius: 15px; padding: 35px 20px; text-align: center; cursor: pointer; transition: 0.3s; font-size: 28px; font-weight: 900; color: #ffffff !important; text-shadow: 2px 2px 0px #000, 0 0 15px rgba(255,255,255,0.3); box-shadow: 0 5px 15px rgba(0,0,0,0.5); letter-spacing: 1px; }
    .theme-card:hover { transform: translateY(-5px); border-color: #fff; box-shadow: 0 10px 25px rgba(255,255,255,0.2); background: #333; }
    
    header { min-height: 110px; background: var(--panel); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 2px solid rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; transition: background 0.5s ease; }
    .brand { font-size: 40px; font-weight: 900; letter-spacing: -2px; text-shadow: var(--accent-glow); color: var(--text); }
    .header-right { display: flex; align-items: center; gap: 20px; }

    .mode-btn, .display-btn { font-size: 18px; cursor: pointer; color: var(--text); opacity: 0.8; border: 1px solid var(--text); padding: 8px 15px; border-radius: var(--border-radius); font-weight: bold; transition: 0.2s; background: transparent; }
    .mode-btn.active, .display-btn.active { opacity: 1; background: var(--accent); border-color: var(--accent); color: white; box-shadow: var(--accent-glow); transform: scale(1.05); }
    .theme-switch-btn { font-size: 14px; background: rgba(255,255,255,0.1); border: 1px solid var(--text); color: var(--text); padding: 5px 10px; border-radius: var(--border-radius); cursor: pointer; }

    .metro-controls { display: flex; flex-direction: column; align-items: center; gap: 5px; border-left: 1px solid var(--text); padding-left: 15px; }
    .bpm-slider { width: 100px; accent-color: var(--accent); cursor: pointer; }
    .bpm-text { font-size: 12px; color: var(--accent); font-weight: bold; }

    .vol-stack { display: flex; flex-direction: column; align-items: center; }
    .vol-label { font-size: 20px; color: var(--text); opacity: 0.7; font-weight: bold; margin-bottom: 5px; }
    .vol-grid { display: flex; gap: 5px; }
    .vol-segment { width: 25px; height: 14px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); cursor: pointer; }
    .vol-segment.active { background: var(--accent); box-shadow: var(--accent-glow); border-color: var(--accent); }

    .score-rack { width: 100%; min-height: 0; background: rgba(0,0,0,0.2); display: none; flex-direction: row; align-items: center; justify-content: center; gap: 20px; border-bottom: 2px solid rgba(0,0,0,0.2); padding: 15px; transition: 0.5s; }
    .score-rack img { max-width: 300px; height: auto; border-radius: 5px; display: none; }
    .upload-group { display: flex; flex-direction: column; gap: 10px; flex: 1; max-width: 350px; }
    .upload-hint { border: 2px dashed var(--accent); padding: 15px; color: var(--text); opacity: 0.7; cursor: pointer; border-radius: var(--border-radius); text-transform: uppercase; text-align: center; font-size: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70px; }
    .upload-hint.ready { border-style: solid; background: rgba(168, 85, 247, 0.2); color: white; opacity: 1; border-color: #fff; }

    .piano-section { padding: 20px 0; display: flex; flex-direction: column; align-items: center; width: 100%; }
    .lcd-tech { width: 420px; height: 160px; background: var(--lcd-bg); border: var(--lcd-border); border-radius: var(--border-radius); display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; transition: 0.4s ease; }
    .metro-light { width: 20px; height: 20px; background: rgba(0,0,0,0.3); border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--text); }
    .metro-flash { background: #fff !important; box-shadow: 0 0 20px #fff, 0 0 50px var(--accent) !important; transform: scale(1.3); }
    .lcd-flash { box-shadow: 0 0 30px var(--accent) !important; }
    
    #shiftIndicator { position: absolute; top: 10px; right: 15px; font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; color: #555; border: 1px solid #555; font-weight: bold; transition: 0.2s; }
    #shiftIndicator.active { background: var(--accent); color: #fff; border-color: #fff; box-shadow: 0 0 10px var(--accent); }
    #octaveDisplay { position: absolute; top: 10px; left: 15px; font-size: 12px; color: var(--accent); font-weight: bold; letter-spacing: 1px; }

    #noteOut { font-size: 32px; font-weight: bold; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
    #solOut { font-size: 16px; color: var(--accent); letter-spacing: 2px; }

    /* ÈÄ≤Â∫¶Ê¢ùËàáÈÄüÂ∫¶ÊéßÂà∂ */
    .seek-container { width: 90%; margin-top: 5px; display: flex; align-items: center; gap: 8px; }
    .seek-slider { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; }
    .time-text { font-size: 10px; color: var(--accent); font-family: monospace; min-width: 35px; }

    /* Control Row for Speed & Gate */
    .control-row { display: flex; gap: 20px; margin-top: 10px; align-items: center; width: 90%; justify-content: center; }
    .control-group { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--accent); }
    .control-group input { width: 70px; accent-color: var(--accent); }

    body.score-active .score-rack { display: flex; min-height: 250px; }
    body.score-active .lcd-tech { position: fixed; left: 20px; top: 50%; transform: translateY(-50%) scale(0.7); z-index: 1500; background: var(--lcd-bg); opacity: 0.95; }

    .piano-scroll { width: 100%; overflow-x: auto; padding: 10px 0; scroll-behavior: smooth; }
    .keyboard { position: relative; width: max-content; height: 260px; margin: 0 auto; }
    .white-keys { display: flex; }
    .key-white { width: var(--white-w); height: 240px; background: var(--key-white-bg); border: 1px solid #999; border-radius: 0 0 5px 5px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 12px; color: #000; cursor: pointer; position: relative; }
    .key-white.active { transform: translateY(2px); border-bottom: 10px solid var(--accent); filter: brightness(0.9); }
    .black-keys { position: absolute; top: 0; left: 0; width: 100%; height: 150px; pointer-events: none; }
    .key-black { position: absolute; width: var(--black-w); height: 150px; background: var(--key-black-bg); border-radius: 0 0 4px 4px; pointer-events: auto; z-index: 10; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 10px; color: #fff; cursor: pointer; }
    .key-black.active { transform: translateY(2px); border-bottom: 8px solid var(--accent); filter: brightness(1.2); }
    .key-tag { font-size: 11px; font-weight: bold; pointer-events: none; margin-bottom: 2px; }
    .octave-active { background: var(--octave-active-bg) !important; box-shadow: inset 0 0 20px var(--accent); }
    
    .guide-active { box-shadow: inset 0 0 25px var(--guide-color), 0 0 15px var(--guide-color) !important; border-bottom: 10px solid var(--guide-color) !important; z-index: 20; transition: box-shadow 0.2s ease-out; }
    .hide-tags .key-tag { display: none; }

    #sunoPlayerUI { display: none; align-items: center; gap: 8px; border: 1px solid var(--accent); padding: 5px 12px; border-radius: 20px; margin-right: 15px; background: rgba(0,0,0,0.5); }
    #sunoName { font-size: 10px; color: var(--accent); opacity: 0.9; max-width: 60px; overflow: hidden; white-space: nowrap; }
    .mode-btn-suno { background: rgba(255,255,255,0.1); color: var(--text); border: 1px solid #555; padding: 5px 10px; border-radius: 8px; font-size: 11px; cursor: pointer; transition: 0.2s; }
    .mode-btn-suno:hover { border-color: var(--accent); }
    .mode-btn-suno.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); font-weight: bold; }

    #dropdownMenu { position: absolute; top: 110px; right: 30px; background: var(--panel); border: 1px solid var(--text); padding: 20px; display: none; flex-direction: column; gap: 15px; z-index: 2000; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .instrument-display { padding: 40px 20px; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 20px; border-top: 1px solid #333; }
  </style>
</head>
<body class="theme-tech show-labels">
  
  <div id="themeModal">
    <div class="modal-title">Select Your Piano Style</div>
    <div class="theme-grid">
      <div class="theme-card card-cartoon" onclick="selectTheme('theme-cartoon')">üåà Cartoon</div>
      <div class="theme-card card-tech" onclick="selectTheme('theme-tech')">‚ö° Cyberpunk</div>
      <div class="theme-card card-pro" onclick="selectTheme('theme-pro')">üéπ Classic Pro</div>
      <div class="theme-card card-nature" onclick="selectTheme('theme-nature')">üåä Ocean Breeze</div>
    </div>
  </div>

  <header>
    <div class="brand">Qq Music</div>
    <div class="header-right">
      <button class="theme-switch-btn" onclick="openThemeModal()">üé® Theme</button>
      
      <div id="sunoPlayerUI">
        <span id="sunoName">Ready</span>
        <button class="theme-switch-btn" onclick="toggleSunoPlayback()">‚èØ</button>
        <button id="btnBacking" class="mode-btn-suno" onclick="setPlayMode('backing')">üéπ Backing</button>
        <button id="btnVocal" class="mode-btn-suno" onclick="setPlayMode('vocal')">üé§ Vocal</button>
        <button id="btnAuto" class="mode-btn-suno active" onclick="setPlayMode('auto')">ü§ñ Ensemble</button>
      </div>

      <div id="scoreBtn" class="mode-btn" onclick="toggleScoreMode()">Score & Suno</div>
      <div id="accompBtn" class="mode-btn" onclick="toggleAccomp()">Accomp</div>
      <div class="metro-controls">
        <div id="metroBtn" class="mode-btn" onclick="toggleMetro()">Metro</div>
        <input type="range" class="bpm-slider" min="40" max="220" value="120" oninput="updateBPM(this.value)">
        <span class="bpm-text" id="bpmText">120 BPM</span>
      </div>
      <div class="vol-stack">
        <div class="vol-label">VOICE</div>
        <div class="vol-grid">
          <div class="vol-segment" id="vol1" onclick="setVol(1)"></div>
          <div class="vol-segment" id="vol2" onclick="setVol(2)"></div>
          <div class="vol-segment active" id="vol3" onclick="setVol(3)"></div>
          <div class="vol-segment" id="vol4" onclick="setVol(4)"></div>
        </div>
      </div>
      <div id="dToggle" class="display-btn active" onclick="toggleDisplay()">Display</div>
      <div style="font-size:35px; cursor:pointer;" onclick="toggleMenu()">&#9776;</div>
    </div>

    <div id="dropdownMenu">
      <label>Instrument:</label>
      <select id="instSelect" onchange="changeInstrument()" style="padding:10px; background:#222; color:white; border:1px solid var(--accent); font-size: 16px;">
        <option value="piano">Grand Piano üéπ</option>
        <option value="violin">Solo Violin üéª</option>
        <option value="strings">Orchestra üéª</option>
        <option value="flute">Concert Flute ü™à</option>
        <option value="guitar">Nylon Guitar üé∏</option>
      </select>
      <hr style="border-color:#333;">
      <label style="cursor: pointer;"><input type="checkbox" id="sustainCheck" checked> Sustain</label>
      <button class="theme-switch-btn" style="width:100%; margin-top:10px;" onclick="openThemeModal()">Reselect Theme</button>
    </div>
  </header>

  <div class="score-rack" id="scoreRack">
    <div class="upload-group">
        <div class="upload-hint" onclick="document.getElementById('fileInput').click()">üì∑ 1. Upload Score</div>
        <input type="file" id="fileInput" accept="image/*" onchange="loadScore(event)" style="display:none;">
        <img id="scoreImg" src="">
    </div>
    <div class="upload-group">
        <div id="backingHint" class="upload-hint" style="border-color:var(--guide-color);" onclick="document.getElementById('backingInput').click()">
            üéµ 2. Upload Backing
        </div>
        <div id="vocalHint" class="upload-hint" style="border-color:var(--guide-color);" onclick="document.getElementById('vocalInput').click()">
            üé§ 3. Upload Vocal
        </div>
        <input type="file" id="backingInput" accept="audio/*" onchange="loadAudio(event, 'backing')" style="display:none;">
        <input type="file" id="vocalInput" accept="audio/*" onchange="loadAudio(event, 'vocal')" style="display:none;">
    </div>
  </div>

  <div class="piano-section">
    <div class="lcd-tech" id="lcd">
      <div id="octaveDisplay">OCT: 4</div>
      <div id="shiftIndicator">SHIFT MOD</div>
      <div id="metroLight" class="metro-light"></div>
      <div id="noteOut">READY</div>
      
      <div class="seek-container">
        <span class="time-text" id="timeCur">0:00</span>
        <input type="range" id="seekSlider" class="seek-slider" min="0" max="100" value="0" oninput="seekAudio(this.value)">
        <span class="time-text" id="timeTotal">0:00</span>
      </div>
      
      <div class="control-row">
        <div class="control-group">
            Speed: <span id="speedVal">1.0x</span>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" oninput="setSpeed(this.value)">
        </div>
        <div class="control-group">
            Noise Gate: 
            <input type="range" id="gateSlider" min="0" max="0.5" step="0.01" value="0.2">
        </div>
      </div>

    </div>
    <div class="piano-scroll">
      <div class="keyboard" id="kbRoot">
        <div class="white-keys" id="whiteKeys"></div>
        <div class="black-keys" id="blackKeys"></div>
      </div>
    </div>
  </div>

  <div class="instrument-display">
    <div id="instIcon" style="font-size:50px;">üéπ</div>
    <div id="instName" style="font-size:30px; font-weight:bold; color:var(--accent);">GRAND PIANO</div>
  </div>

<script>
  let aCtx, masterGain, reverbNode, analyser;
  let backingBuffer, vocalBuffer, backingSource, vocalSource;
  let backingGainNode, vocalGainNode;
  let isPlaying = false, startTime = 0, pausedAt = 0;
  let detectLoop, progressInterval;
  let playbackSpeed = 1.0;

  let lastMidi = null, stabilityCount = 0;
  const STABILITY_THRESHOLD = 3;
  let lastNoteTime = 0, clearTimer = null;
  const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const LETTER_MAP = { 'c':0, 'd':2, 'e':4, 'f':5, 'g':7, 'a':9, 'b':11 };
  let accompOn = false, metroOn = false, bpm = 120, metroTimer;
  const activeOctaves = new Set();
  const activeDisplayMidis = new Set();

  function selectTheme(t) { document.body.className = t + ' show-labels'; document.getElementById('themeModal').style.display = 'none'; if(!aCtx) initApp(); }
  function openThemeModal() { document.getElementById('themeModal').style.display = 'flex'; }

  function initApp() {
    aCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = aCtx.createGain(); masterGain.gain.value = 0.6;
    reverbNode = aCtx.createConvolver(); createReverbImpulse();
    analyser = aCtx.createAnalyser(); analyser.fftSize = 2048;
    masterGain.connect(aCtx.destination); masterGain.connect(reverbNode); reverbNode.connect(aCtx.destination);
    buildKeyboard();
    setupControls();
  }

  async function loadAudio(e, type) {
    if(!aCtx) initApp();
    const file = e.target.files[0];
    const ab = await file.arrayBuffer();
    const buffer = await aCtx.decodeAudioData(ab);
    if(type === 'backing') {
        backingBuffer = buffer;
        document.getElementById('backingHint').classList.add('ready');
        document.getElementById('timeTotal').textContent = formatTime(buffer.duration);
    } else {
        vocalBuffer = buffer;
        document.getElementById('vocalHint').classList.add('ready');
    }
    if(backingBuffer && vocalBuffer) document.getElementById('sunoPlayerUI').style.display = 'flex';
  }

  function toggleSunoPlayback() { isPlaying ? pauseSuno() : startSuno(pausedAt); }

  function startSuno(offset) {
    if(!backingBuffer || !vocalBuffer) return;
    backingSource = aCtx.createBufferSource(); backingSource.buffer = backingBuffer;
    vocalSource = aCtx.createBufferSource(); vocalSource.buffer = vocalBuffer;
    
    // Apply Speed
    backingSource.playbackRate.value = playbackSpeed;
    vocalSource.playbackRate.value = playbackSpeed;

    backingGainNode = aCtx.createGain(); vocalGainNode = aCtx.createGain();

    // AI SOURCE SEPARATION (FILTER CHAIN)
    // 1. Highpass to remove Bass/Drums (< 300Hz)
    const highPass = aCtx.createBiquadFilter();
    highPass.type = "highpass"; highPass.frequency.value = 300;

    // 2. Lowpass to remove Hi-Hats/Noise (> 3000Hz)
    const lowPass = aCtx.createBiquadFilter();
    lowPass.type = "lowpass"; lowPass.frequency.value = 3000;

    backingSource.connect(backingGainNode).connect(masterGain);
    vocalSource.connect(vocalGainNode).connect(masterGain);
    
    // Vocal track goes through the filter chain BEFORE hitting the analyser
    vocalGainNode.connect(highPass).connect(lowPass).connect(analyser);

    applyModeSettings();
    backingSource.start(0, offset);
    vocalSource.start(0, offset);
    
    startTime = aCtx.currentTime - offset;
    isPlaying = true;
    detectPitch();
    updateProgress();
  }

  function pauseSuno() {
    isPlaying = false;
    pausedAt = aCtx.currentTime - startTime;
    if(backingSource) backingSource.stop();
    if(vocalSource) vocalSource.stop();
    cancelAnimationFrame(progressInterval);
    clearGuides();
  }

  function setSpeed(v) {
      playbackSpeed = parseFloat(v);
      document.getElementById('speedVal').textContent = playbackSpeed.toFixed(1) + "x";
      if(isPlaying) {
         if(backingSource) backingSource.playbackRate.value = playbackSpeed;
         if(vocalSource) vocalSource.playbackRate.value = playbackSpeed;
      }
  }

  function seekAudio(percent) {
    const wasPlaying = isPlaying;
    const seekTime = (percent / 100) * backingBuffer.duration;
    if(isPlaying) pauseSuno();
    pausedAt = seekTime;
    if(wasPlaying) startSuno(pausedAt);
    document.getElementById('timeCur').textContent = formatTime(seekTime);
  }

  function updateProgress() {
    if(!isPlaying) return;
    const curr = (aCtx.currentTime - startTime) * playbackSpeed; // Adjust progress for speed
    if(curr >= backingBuffer.duration) { pauseSuno(); pausedAt = 0; return; }
    document.getElementById('seekSlider').value = (curr / backingBuffer.duration) * 100;
    document.getElementById('timeCur').textContent = formatTime(curr);
    progressInterval = requestAnimationFrame(updateProgress);
  }

  function formatTime(sec) {
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    return `${m}:${s<10?'0':''}${s}`;
  }

  function detectPitch() {
    if(!isPlaying) return;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    
    // Noise Gate Check (Ignore low volume segments)
    const gateThres = parseFloat(document.getElementById('gateSlider').value);
    let rms = 0; for(let i=0; i<buf.length; i++) rms += buf[i]*buf[i];
    rms = Math.sqrt(rms/buf.length);

    if(rms > gateThres) {
        const freq = autoCorrelate(buf, aCtx.sampleRate);
        if (freq > 0) {
            const midi = Math.round(69 + 12 * Math.log2(freq / 440));
            if(midi >= 21 && midi <= 108) showGuideLight(midi);
        }
    }
    
    requestAnimationFrame(detectPitch);
  }

  function autoCorrelate(buf, sampleRate) {
    let rms = 0; for(let i=0; i<buf.length; i++) rms += buf[i]*buf[i];
    if(Math.sqrt(rms/buf.length) < 0.015) return -1;
    let r1=0, r2=buf.length-1, thres=0.2;
    for(let i=0; i<buf.length/2; i++) if(Math.abs(buf[i])<thres){r1=i; break;}
    for(let i=1; i<buf.length/2; i++) if(Math.abs(buf[buf.length-i])<thres){r2=buf.length-i; break;}
    let b = buf.slice(r1,r2);
    let c = new Array(b.length).fill(0);
    for(let i=0; i<b.length; i++) for(let j=0; j<b.length-i; j++) c[i] = c[i] + b[j]*b[j+i];
    let d=0; while(c[d]>c[d+1]) d++;
    let maxval=-1, maxpos=-1;
    for(let i=d; i<b.length; i++) if(c[i]>maxval){ maxval=c[i]; maxpos=i; }
    return sampleRate/maxpos;
  }

  function showGuideLight(midi) {
    if (midi !== lastMidi) { lastMidi = midi; stabilityCount = 0; return; }
    stabilityCount++;
    if (stabilityCount >= STABILITY_THRESHOLD) {
      const key = document.getElementById(`key-${midi}`);
      if(key) {
          document.querySelectorAll('.guide-active').forEach(el => el.classList.remove('guide-active'));
          key.classList.add('guide-active');
          setTimeout(() => key.classList.remove('guide-active'), 300);
      }
    }
  }

  function clearGuides() { document.querySelectorAll('.guide-active').forEach(el => el.classList.remove('guide-active')); }

  function setupControls() {
    activeOctaves.add(4); highlightOctave(4, true); updateOctaveDisplay();
    window.addEventListener('keydown', e => {
      if(e.repeat) return;
      const k = e.key.toLowerCase();
      if(e.key === 'Shift') { document.getElementById('shiftIndicator').classList.add('active'); return; }
      if (k >= '0' && k <= '8') { 
          const oct = parseInt(k);
          if (activeOctaves.has(oct)) { activeOctaves.delete(oct); highlightOctave(oct, false); }
          else { activeOctaves.add(oct); highlightOctave(oct, true); }
          updateOctaveDisplay(); return;
      }
      if (LETTER_MAP.hasOwnProperty(k)) {
        let noteOffset = LETTER_MAP[k];
        if(e.shiftKey) { if(noteOffset !== 4 && noteOffset !== 11) noteOffset += 1; }
        activeOctaves.forEach(oct => triggerNote((oct+1)*12 + noteOffset));
      }
    });
    window.addEventListener('keyup', e => { if(e.key === 'Shift') document.getElementById('shiftIndicator').classList.remove('active'); });
  }

  function updateOctaveDisplay() {
      const sorted = Array.from(activeOctaves).sort();
      document.getElementById('octaveDisplay').textContent = "OCT: " + (sorted.length ? sorted.join(', ') : "OFF");
  }

  function highlightOctave(oct, active) {
    const s = (oct+1)*12; for (let m = s; m <= s+11; m++) { const k = document.getElementById(`key-${m}`); if(k) active ? k.classList.add('octave-active') : k.classList.remove('octave-active'); }
  }

  function buildKeyboard() {
    const wDiv = document.getElementById('whiteKeys'), bDiv = document.getElementById('blackKeys');
    wDiv.innerHTML = ''; bDiv.innerHTML = '';
    let wCount = 0;
    for(let m=21; m<=108; m++) {
      const name = NOTES[m%12], oct = Math.floor(m/12)-1, isB = name.includes('#');
      const k = document.createElement('div');
      k.id = `key-${m}`;
      if(!isB) {
        k.innerHTML = `<span class="key-tag">${name}${oct}</span>`;
        k.className = 'key-white'; k.onmousedown = () => triggerNote(m);
        wDiv.appendChild(k); wCount++;
      } else {
        k.innerHTML = `<span class="key-tag">${name}${oct}</span>`;
        k.className = 'key-black'; k.style.left = `${(wCount * 52) - 17}px`;
        k.onmousedown = () => triggerNote(m); bDiv.appendChild(k);
      }
    }
  }

  function triggerNote(midi) {
    if(!aCtx) return;
    playTone(midi, aCtx.currentTime);
    const timeNow = Date.now();
    if (timeNow - lastNoteTime > 100) activeDisplayMidis.clear();
    lastNoteTime = timeNow; activeDisplayMidis.add(midi); updateLCD();
    const el = document.getElementById(`key-${midi}`);
    if(el) { el.classList.add('active'); setTimeout(()=>el.classList.remove('active'), 150); }
    if(clearTimer) clearTimeout(clearTimer);
    clearTimer = setTimeout(() => { activeDisplayMidis.clear(); updateLCD(); }, 3000); 
  }

  function updateLCD() {
    if(activeDisplayMidis.size === 0) { document.getElementById('noteOut').textContent = "READY"; return; }
    const sorted = Array.from(activeDisplayMidis).sort((a,b) => a-b);
    const names = sorted.map(m => NOTES[m%12] + (Math.floor(m/12)-1));
    document.getElementById('noteOut').textContent = names.join('+');
  }

  function playTone(midi, time) {
    const freq = 440 * Math.pow(2, (midi-69)/12);
    const inst = document.getElementById('instSelect').value;
    const sus = document.getElementById('sustainCheck').checked;
    const g = aCtx.createGain(); g.connect(masterGain);
    const o = aCtx.createOscillator();
    
    // Simple Synth Logic
    if(inst === 'piano') o.type = 'triangle';
    else if(inst === 'flute') o.type = 'sine';
    else if(inst === 'violin') o.type = 'sawtooth';
    else o.type = 'square';

    o.frequency.setValueAtTime(freq, time);
    g.gain.setValueAtTime(0, time); g.gain.linearRampToValueAtTime(0.5, time + 0.01);
    g.gain.exponentialRampToValueAtTime(0.01, time + (sus ? 2.5 : 0.5));
    o.connect(g); o.start(time); o.stop(time + 3);
  }

  function applyModeSettings() {
    if(!backingGainNode || !vocalGainNode) return;
    const now = aCtx.currentTime;
    if(currentMode === 'backing') { backingGainNode.gain.setValueAtTime(1, now); vocalGainNode.gain.setValueAtTime(0, now); } 
    else if(currentMode === 'vocal') { backingGainNode.gain.setValueAtTime(0, now); vocalGainNode.gain.setValueAtTime(1, now); } 
    else { backingGainNode.gain.setValueAtTime(1, now); vocalGainNode.gain.setValueAtTime(0.4, now); }
  }

  function setPlayMode(mode) {
    currentMode = mode;
    ['btnBacking', 'btnVocal', 'btnAuto'].forEach(id => document.getElementById(id).classList.remove('active'));
    document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
    applyModeSettings();
  }

  function createReverbImpulse() { const r=aCtx.sampleRate, l=r*2, i=aCtx.createBuffer(2,l,r); for(let j=0; j<l; j++){ const n=j/l, env=Math.pow(1-n,2); i.getChannelData(0)[j]=(Math.random()*2-1)*env; i.getChannelData(1)[j]=(Math.random()*2-1)*env; } reverbNode.buffer=i; }
  function toggleScoreMode() { document.body.classList.toggle('score-active'); document.getElementById('scoreBtn').classList.toggle('active'); }
  function loadScore(e) { const r = new FileReader(); r.onload = () => { const i = document.getElementById('scoreImg'); i.src = r.result; i.style.display='block'; }; r.readAsDataURL(e.target.files[0]); }
  function toggleMetro() { metroOn = !metroOn; document.getElementById('metroBtn').classList.toggle('active'); if(metroOn) { metroTimer = setInterval(playClick, (60/bpm)*1000); playClick(); } else clearInterval(metroTimer); }
  function playClick() { const t=aCtx.currentTime, o=aCtx.createOscillator(), g=aCtx.createGain(); o.frequency.value=1000; g.gain.value=0.8; o.connect(g); g.connect(aCtx.destination); o.start(t); o.stop(t+0.08); document.getElementById('lcd').classList.add('lcd-flash'); setTimeout(()=>document.getElementById('lcd').classList.remove('lcd-flash'), 100); }
  function updateBPM(v) { bpm = v; document.getElementById('bpmText').textContent = v + " BPM"; if(metroOn) { clearInterval(metroTimer); metroTimer = setInterval(playClick, (60/bpm)*1000); }}
  function setVol(lv) { masterGain.gain.setTargetAtTime({1:0.1, 2:0.35, 3:0.65, 4:1.0}[lv], aCtx.currentTime, 0.05); for(let i=1; i<=4; i++) document.getElementById(`vol${i}`).classList.toggle('active', i===lv); }
  function toggleDisplay() { document.getElementById('kbRoot').classList.toggle('hide-tags'); document.getElementById('dToggle').classList.toggle('active'); }
  function toggleMenu() { const m = document.getElementById('dropdownMenu'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
  function changeInstrument() { const v = document.getElementById('instSelect').value; document.getElementById('instName').textContent = v.toUpperCase(); document.getElementById('instIcon').textContent = {piano:'üéπ', strings:'üéª', violin:'üéª', flute:'ü™à', guitar:'üé∏'}[v]; }
  function toggleAccomp() { accompOn = !accompOn; document.getElementById('accompBtn').classList.toggle('active'); }

  window.onload = initApp;
</script>
</body>
</html>